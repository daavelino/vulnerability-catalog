<!DOCTYPE html>
<html>
<head>
<title>{% block title %}{% endblock %}</title>
<link rel="icon" sizes="any" type="image/svg+xml" href="/static/imgs/artifacts/favicon.svg">

  {% load static %}
  <!--Bootstrap resources-->
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8">
  <link rel="stylesheet" href="{% static 'css/bootstrap.min.css' %}">
  <link rel="stylesheet" href="{% static 'css/catalog.css' %}">
  <link rel="stylesheet" href="{% static 'css/dc.css' %}">
  <script src="{% static 'js/jquery.min.js' %}"></script>
  <script src="{% static 'js/popper.min.js' %}"></script>
  <script src="{% static 'js/bootstrap.min.js' %}"></script>
  <!--End of Bootstrap resources-->

  <!-- Data Driven Document (d3js) resources-->
  <script src="{% static 'js/crossfilter.js' %}"></script>
  <script src="{% static 'js/d3.v3.js' %}"></script>
  <script src="{% static 'js/dc.js' %}"></script>
  <!-- End of Data Driven Document (d3js) resources-->
</head>
  
{% load i18n %}
<body>
  <!--Navigation Menu-->
  <nav class="navbar navbar-expand-md navbar-dark bg-dark">
    <a class="navbar-brand" href="{% url 'catalog:home' %}">{% trans 'Home' %}</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
    </button>
    
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav mr-auto">
        <li class="nav-item">
          <a class="nav-link" href="{% url 'catalog:index' %}">{% trans 'Catalog' %}</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{% url 'catalog:panorama' %}">{% trans 'Panorama' %}</a>
        </li>
        <li class="nav-item">
          <div class="btn-group">
            <button type="button" class="btn btn-success createButton" onclick='location.href="{% url 'catalog:addVulnerability' %}"'>Add a vulnerability</button>
          </div>
        </li>
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Resources</a>
          <div class="dropdown-menu" aria-labelledby="navbarDropdown">
            <a class="dropdown-item" href="{% url 'catalog:exportData' %}">Export data</a>
            <a class="dropdown-item" href="{% url 'catalog:massiveUpload' %}">Massive upload</a>
            <a class="dropdown-item" href="{% url 'catalog:converter' %}">Convert data to upload</a>
          </div>
        </li>
      </ul>
      <button class="btn btn-outline-success my-2 my-sm-0" type="button" data-toggle="modal" data-target="#searchModal">Search</button>
    </div>
  </nav>
  <!--END Navigation Menu-->

  <!-- The search Modal -->
  <div class="modal fade" id="searchModal">
    <div class="modal-dialog">
      <div class="modal-content">
        <!-- Modal body -->
        <div class="modal-body">
          <form class="form" method="post" action="{% url 'catalog:search' %}">
            {% csrf_token %}
            <div class="input-group">
              <input class="form-control input-sm" type="search" aria-label="Search" name="q" autofocus>
              <span class="input-group-btn">
                <button type="submit" class="btn btn-secondary">Submit</button>
              </span>
            </div>
          </form>
          <br class="clear">
          <span>You can use fields lookup filters like 'risk__contains=high', 'cvss_score__gt=8', etc. <a href="https://github.com/daavelino/vulnerability-catalog/wiki/Using-the-search-function" target="_blank">See documentation,</a></span>
          <br class="clear">
          <br class="clear">
          <span>Without fields lookup, search will <strong>only</strong> look at <strong>'system', 'vulnerability, and 'owner'</strong> fields.</span>
        </div>
      </div>
    </div>
  </div>
  <!-- End search Modal -->

  <!-- Container -->
  <div id="container" class="container-fluid">
    <!-- Header -->
    <div id="user-tools" class="row">
      <div class="col">
        <span>Hello </span><strong>{% firstof user.get_short_name user.get_username %}</strong>.
      </div>
      <div class="col text-right">
        <div class="btn-group btn-group-sm">
          <button type="button" class="btn btn-light dropdown-toggle" data-toggle="dropdown">Account</button>
          <div class="dropdown-menu dropdown-menu-right">
            <a class="dropdown-item" href="{% url 'admin:password_change' %}">Change password</a>
            <a class="dropdown-item" href="{% url 'catalog:logout' %}">Logout</a>
          </div>
        </div> 
      </div>
    </div>
    <!-- END Container -->
  </div>
  <!-- END Header -->

  <!-- Start custom Content -->
    <!-- converter_custom_content.html -->
<div class="container">
  <table class="table table-sm">
    {% csrf_token %}
    <h4>Fill the forms to equalize data:</h4>
    <br class="clear">
    <tbody>
      <tr>
        <th>
          <label for="convertForm">Owner:</label>
        </th>
        <td>
          <input type="text" class="form-control" id="owner" name="owner" required="True">
        </td>
      </tr>
      <tr>
        <th>
          <label for="exampleFormControlInput1">Owner email:</label>
        </th>
        <td>  
          <input type="email" class="form-control" id="owner_email" name="owner_email" required="True">
        </td>
      </tr>
      <tr>
        <th>
          <label for="convertForm">Environment:</label>
        </th>
        <td>
          <input type="text" class="form-control" id="environment" name="environment" required="True">
        </td>
      </tr>
      <tr>
        <th>
          <label for="convertForm">Perimeter</label>
        </th>
        <td>
          <select id="perimeter" name="perimeter" class="form-control">
            <option selected>External</option>
            <option>Internal</option>
           </select>
        </td>
      </tr>
      <tr>
        <th>
          <label for="convertForm">Technology:</label>
        </th>
        <td>
          <input type="text" class="form-control" id="technology" name="technology" required="True">
        </td>
      </tr>
      <tr>
        <th>
          <label for="convertForm">System type:</label>
        </th>
        <td>
          <input type="text" class="form-control" id="system_type" name="system_type" required="True">
        </td>
      </tr>
      <tr>
        <th>
          <label for="convertForm">Status:</label>
        </th>
        <td>
          <select id="status" name="status" class="form-control">
            <option>Mitigated</option>
            <option selected>Not identified</option>
            <option>Notified</option>
            <option>Risk accepted</option>
            <option>Solved</option>
          </select>
        </td>
      </tr>
      <tr>
        <th>
          <label for="convertForm">Identification date:</label>
        </th>
        <td>
          <input type="date" class="form-control" id="identification_date" name="identification_date" required="True">
        </td>
      </tr>
      <tr>
        <th>
          <label for="convertForm">Remediation deadline:</label>
        </th>
        <td>
          <input type="date" class="form-control" id="remediation_deadline" name="remediation_deadline" required="True">
        </td>
      </tr>
      <tr>
        <th>
          <label for="convertForm">Reporter:</label>
        </th>
        <td>
          <select id="reporter" name="reporter" class="form-control">
            <option selected>OpenVAS (any)</option>
            <option>Nessus (7.1)</option>
            <option>Custom CSV file (.csv)</option>
         </select>
        </td>
      </tr>
    </tbody>
  </table>

  <br class="clear">
  <div class="form-group">
    <label for="convertForm">Upload a CSV file:</label>
    <input type="file" accept=".csv" class="form-control-file" id="uploadedFile" name="uploadedFile" required="True">      
  </div>
    <label>Ommit dupplicated </label>           
    <input type="checkbox" id="ommit_dupplicated" name="ommit_dupplicated">
    <br class="clear">
    <br class="clear">
    <button type="submit" class="btn btn-primary" onclick="convert()">Convert</button>
  </div>
</div>
     
<br class="clear">
<br class="clear">

<script>
  function convert(event) {
    // Convert CSV report file into a Massive upload Catalog JSON file.

    var header_maps = [
      {
      'name':'Nessus (7.1)',
      'map': {
        'cvss_value':'CVSS',
        'observation':['Description','See Also'],
        'remediation':'Solution',
        'risk':'Risk',
        'synopsis':'Synopsis',
        'system':'Host',
        'vulnerability':'Name'
        }
      },
      {
      'name': 'OpenVAS (any)',
      'map': {
        'cvss_value':'CVSS',
        'observation':'Specific Result',
        'remediation':'Solution',
        'risk':'Severity',
        'synopsis':'Summary',
        'system':['Hostname','IP'],
        'vulnerability':'NVT Name'
        }
      },
      {
      'name': 'Custom CSV file (.csv)',
      'map': {
        'cvss_value':'CVSS',
        'observation':'Observation',
        'remediation':'Remediation',
        'risk':'Risk',
        'synopsis':'Synopsis',
        'system':'System',
        'vulnerability':'Vulnerability'
        }
      }
    ];

    var vulnerability = {
      "model": "catalog.vulnerability",
      "fields": {
      "system": null,
      "owner": null,
      "owner_email": null,
      "environment": null,
      "perimeter": null,
      "technology": null,
      "system_type": null,
      "status": null,
      "vulnerability": null,
      "category": "",
      "synopsis": null,
      "cvss_value": null,
      "identification_date": null,
      "reporter": null,
      "risk": null,
      "observation": null,
      "remediation": null,
      "risk_acceptance_reason": "",
      "remediation_deadline": null,
      "report_file": null,
      "report_page": 0
      }
    };
  
    var form_fields = [
      'owner',
      'owner_email',
      'environment',
      'perimeter',
      'technology',
      'system_type',
      'status',
      'identification_date',
      'remediation_deadline',
      'reporter'
      ];

    // Sanitizing input and prefill vulnerability object:
    for (let i=0; i<form_fields.length; i++) {
      let field = form_fields[i];
      let input_value = document.getElementById(field).value;
      if (! input_value) {
        console.log('Missing some form field. Exiting.')
        return 1
      } else {
        vulnerability['fields'][field] = input_value;
      }
    }
    var input_file = document.getElementById('uploadedFile').files[0];
    if (! input_file) {
      console.log('Missing file to be converted. Exiting.')
      return 1
    } else {
      vulnerability['fields']['report_file'] = input_file.name;
    }
    var ommit_dupplicated = document.getElementById('ommit_dupplicated');
    if (! ommit_dupplicated) {
      console.log('Assuming ommit_dupplicated == False.')
      ommit_dupplicated = false;
    } else {
      ommit_dupplicated = ommit_dupplicated.checked;
    }
    // End Sanitizing input and prefill vulnerability object.

    // Processing CSV data via d3:
    var csv2json = function(data) {
      var result = [];
      for (i=0; i<header_maps.length;i++) {
        if (header_maps[i]['name'] !== vulnerability['fields']['reporter']) {
          continue;
          } else {
            var map_converter = header_maps[i]['map'];
            break;
          } 
        }
        if (! map_converter) {
          console.log('Unable to find a map to parse CSV file. Exiting.')
          return 1
        }

      var map_keys = Object.keys(map_converter);

      d3.csv(data, function (d) {
        for (i=0;i<d.length;i++) {
          var row = d[i];        
          for (j=0;j<map_keys.length;j++) {
            var map_key = map_keys[j];
            var map_value = map_converter[map_key];
            var field = row[map_value];

            if (map_key === 'cvss_value') {
              field = parseFloat(field);
              if (isNaN(field)) {
                field = 0;
              }
            }
            if (map_key === 'risk') {
              if (field === 'None' || field ==='') {
                field = 'Not evaluated';
              }
            }
                     
            if (Array.isArray(map_value)) {
              field = '';
              for (k=0;k<map_value.length;k++) {
                let tmp = map_value[k];
                if (tmp === '') {
                  continue;
                }
                field = field + row[tmp] + '; ';
              }
              field = field.slice(0, -2);
            }

            vulnerability['fields'][map_key] = field;

          }

          if (ommit_dupplicated) {
            if (result.includes(JSON.stringify(vulnerability))) {
              continue;
            }
          }
          result.push(JSON.stringify(vulnerability));
        }

        result = '[' + result + ']';
        // Present data to download:
        var a = document.createElement('a');
        var blob = new Blob([result], {'type':'application/json'});
        a.href = window.URL.createObjectURL(blob);
        a.download = 'Catalog-' + vulnerability['fields']['report_file'] + '.json';
        a.click();
        // End Present data to download.

      });
      
    };
    
    // End Processing CSV data via d3.

    // Reading CSV file and call csv2json():
    if (input_file) {
      var reader = new FileReader();
      reader.addEventListener('loadend', function() {
        var data = reader.result;
        csv2json(data);
      }, false);
      reader.readAsDataURL(input_file);
    }
    // End Reading CSV file and call csv2json().
    
    return 0
  }
</script>
<!-- converter_custom_content.html -->
  <!-- end custom Content -->
  <div class="container fixed-bottom text-center bg-light d-none d-md-block">
    <footer class="footer">
      <small>
        <span class="text-muted">Vulnerability Catalog is a Free Software. Visit <a href="https://github.com/daavelino/vulnerability-catalog">our GitHub page</a> to know more. Proudly made in <img src="{% static 'imgs/artifacts/br-flag-tiny.svg' %}">.</span></small>

    </footer>  
  </div>  

  <script src="/static/js/html.helper.js"></script>
</body>
</html>
<!--tmpl_main.html-->