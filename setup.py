########
#### setup.py: script to build and help development of the Vulnerability catalog.
#### Date: 2019-Jun-13
#### Version: 2.2.0
#### Author: Daniel Avelino https://daavelino.github.io
########

import sys

MINIMAL_PYTHON_VERSION = (3, 6, 0)

python_version = True
if sys.version_info.major < MINIMAL_PYTHON_VERSION[0]:
    python_version = False
if sys.version_info.major == MINIMAL_PYTHON_VERSION[0]:
    if sys.version_info.minor < MINIMAL_PYTHON_VERSION[1]:
        python_version = False
if not python_version:
    min_python = str(MINIMAL_PYTHON_VERSION[0]) + '.' \
               + str(MINIMAL_PYTHON_VERSION[1]) + '.' \
               + str(MINIMAL_PYTHON_VERSION[2])
    error = '\n[Warning]:\n\nMissing Python ' + min_python + \
        ' (or greater).\n\n' + \
        'Please, get it at https://www.python.org/downloads.\n\n' + \
        'Aborting.\n\n'
    sys.stderr.write(error)
    sys.exit(1)
   
import secrets # secrets is New in Python 3.6.
import shutil
import os
import subprocess
import getpass
import re
import json
import time

from pathlib import Path

global PROJECT_NAME
global APP_NAME
global HOME_DIR
global PYTHON_EXE


PROJECT_NAME = 'base'
APP_NAME = 'catalog'
HOME_DIR = Path(os.getcwd())
BASE_DIR = Path(os.path.join(HOME_DIR, PROJECT_NAME,))
PYTHON_EXE = os.path.split(Path(sys.executable))[-1]
PIP_EXE = PYTHON_EXE.replace('python', 'pip')

######## System properties:
def get_os():
    '''
       Returns a dictionary with OS system and version.
       The returned values are:

       Linux: 'linux'
       Windows: 'win32'
       Windows/Cygwin: 'cygwin'
       Mac OS X: 'darwin'
      '''
    env = dict()
    env['system'] = sys.platform
    
    return env

def check_parameters():
    allowed_params = {
        'build': "setup and builds the project from the scratch (with test data).\n",
        'build-only': "Just build project, without load data or create users.\n",
        'build-novenv': "same as 'build', but do not uses Python venv.\n",
        'clean': "remove all project related files.\n",
        'createstartscript': "creates the platform specific Catalog start script.\n",
        'createsuperuser': "creates an admin user to the catalog.\n",
        'database': "Setup an alternative database instead of default sqlite.\n",
        'deep-clean': "remove all project related files and venv structure.\n",
        'loadtestdata': "Add some test data into database.\n",
        'templates': "updates project's Templates, forms and static files only.\n",
        'update-js': "updates external JavaScript dependencies\n",
        'urlsviews': "updates project's Urls and Views only.\n"   
    }
    # one and only one allowed parameter has to be passed.
    if (len(sys.argv) == 2) and (sys.argv[1] in allowed_params.keys()):
        param = sys.argv[1] # Because argv[0] is the file name.
        return param
    else:
        sys.stderr.write('\nUsage:' + sys.argv[0] + ' <options>, where <options> are:\n\n')
        for i in allowed_params.items():
            sys.stderr.write('  ' + i[0] + ':    ' + i[1])
        sys.stderr.write('\nExiting.\n')
        sys.exit(1)

def check_venv():
    ''' Check if Python's virtual environment is activated.'''
    param = check_parameters()
    if param == 'build-novenv':
        return True
    elif param == 'clean' or param == 'deep-clean':
        pass
    else:
        if 'VIRTUAL_ENV' not in os.environ.keys():
            message = "\n[Warning]: You are not using a Virtual environment.\n\n\n" \
                    + "**** If not sure, type [ctrl]+[c] to exit. ****\n\n\n" \
                    + "    We encourage the usage of a Virtual environment in a non dedicated system.\n\n" \
                    + "    You can activate it by:\n\n" \
                    + "    1. create a new Virtual environment directory by running:\n\n" \
                    + "        " + PYTHON_EXE + " -m venv venv\n\n" \
                    + "    2. load it by running:\n" \
                    + "        'source venv/bin/activate' (Linux/MacOs system)\n" \
                    + "        'venv\\Scripts\\Activate.bat' (Windows system)\n\n" \
                    + "    If you choose not use a Virtual environment, remember that you can remove the installed dependencies by running\n\n" \
                    + "        'pip uninstall -r requirements.txt' \n\n"
                               
            sys.stdout.write(message)
            time.sleep(10)
            
            return True

    return True

def check_pip():
    '''Check if pip is installed. If not, install it properly.'''
    try:
        import pip
    except ImportError: # Exit, since it is a required dependency.
        sys.stdout.write('\n[Warning]    Missing pip.\n')
        sys.stdout.write('Please, install it first from here (https://pip.pypa.io), or from your package manager.\nExiting.\n')
        sys.exit(1)

def check_requirements():
    '''Ensure requirements.txt is satisfied.'''
    os.system(PIP_EXE + ' ' + 'install -r requirements.txt')
    sys.stdout.write('Done\n')

def check_system_reqs():
    check_pip()
    check_requirements()

def deep_clean(control):
    '''Cleaning out old project structure'''
    env = get_os()
    system = env['system']
    sys.stdout.write('Cleaning out old project structure...\n')
    
    if control == 'deep-clean':
        if 'VIRTUAL_ENV' in os.environ.keys():
            message = "\n[Warning]:\n\n" \
                + "Please disable the Virtual environment first by running:\n\n" \
                + "    'deactivate'\n\n" \
                + "and run this script again. Aborting.\n"
            sys.stderr.write(message)
            sys.exit(-1)
        else:
            target = Path(os.path.join(os.path.curdir, 'venv'))
            if target.is_dir():
                shutil.rmtree(target)
            target = Path(os.path.join(os.path.curdir, 'base'))
            if target.is_dir():
                shutil.rmtree(target)


    if system.startswith('linux') or system.startswith('darwin'):
        filename = 'run.sh'
    if system.startswith('win32'):
        filename = 'run.bat'
    if os.path.isfile(filename):
        os.remove(filename)
    sys.stdout.write('Done\n')

    
######## End of System properties.

######## Django properties:
def start_django_project():
    '''Starts Django's project creation.'''
    sys.stdout.write('Starting creating Django structure...\n')
    os.system('django-admin startproject' + ' ' + PROJECT_NAME)
    os.chdir(BASE_DIR)
    os.system(PYTHON_EXE + ' ' + 'manage.py startapp' + ' ' + APP_NAME)
    os.chdir(HOME_DIR)
    sys.stdout.write('Done\n')

def importing_settings():
    '''
    Applying settings from 
    metadata/settings/settings.py
    into project's structure
    '''
    sys.stdout.write('Copy settings.py from metadata...\n')
    src_path = os.path.join(os.path.curdir, \
                            'metadata', \
                            'settings', \
                            'settings.py')
    dst_path = os.path.join(os.path.curdir, 'base', 'base', 'settings.py')
    shutil.copy(src_path, dst_path)
    sys.stdout.write('Done\n')

def importing_cherrypy_script():
    '''
    Importing the cherrypy wsgi server script.
    '''
    sys.stdout.write('Copy run_cherrypy.py from metadata...\n')
    src_path = os.path.join(os.path.curdir, \
                            'metadata', \
                            'base', \
                            'run_cherrypy.py')
    dst_path = os.path.join(os.path.curdir, 'base', 'run_cherrypy.py')
    shutil.copy(src_path, dst_path)
    sys.stdout.write('Done\n')

def set_datamodel():
    '''
    Applying catalog data models from
    metadata/models/catalog/models.py and
    metadata/models/catalog/admin.py 
    into project's structure.
    '''
    env = get_os()
    sys.stdout.write('Copy data models...\n')
    src_path = os.path.join(os.path.curdir, \
                            'metadata', \
                            'models', \
                            'catalog', \
                            'models.py')
    dst_path = os.path.join(os.path.curdir, 'base', 'catalog', 'models.py')
    shutil.copy(src_path, dst_path)
    src_path = os.path.join(os.path.curdir, \
                            'metadata', \
                            'models', \
                            'catalog', \
                            'admin.py')
    dst_path = os.path.join(os.path.curdir, 'base', 'catalog', 'admin.py')
    shutil.copy(src_path, dst_path)
    sys.stdout.write('Done\n')
    sys.stdout.write('Applying data models...\n')
    os.chdir(PROJECT_NAME)
    os.system(PYTHON_EXE + ' ' + 'manage.py makemigrations' + ' ' + APP_NAME)
    os.system(PYTHON_EXE + ' ' + 'manage.py sqlmigrate' \
              + ' ' \
              + APP_NAME \
              + ' ' \
              + '0001')
    os.system(PYTHON_EXE + ' ' + 'manage.py migrate')
    os.chdir(BASE_DIR)
    sys.stdout.write('Done\n')

def set_urls():
    '''
    Applying settings from 
    metadata/urls/catalog/urls.py and
    metadata/urls/catalog/urls.py
    into project's structure.
    '''
    sys.stdout.write('Setting Urls...\n')
    os.chdir(HOME_DIR)
    src_path = os.path.join(os.path.curdir, \
                            'metadata', \
                            'urls', \
                            'admin', \
                            'urls.py')
    dst_path = os.path.join(os.path.curdir, 'base', 'base', 'urls.py')    
    shutil.copy(src_path, dst_path)
    src_path = os.path.join(os.path.curdir,\
                            'metadata', \
                            'urls', \
                            'catalog', \
                            'urls.py')
    dst_path = os.path.join(os.path.curdir, 'base', 'catalog', 'urls.py')
    shutil.copy(src_path, dst_path)
    sys.stdout.write('Done\n')

def set_views():
    '''
    Applying settings from 
    metadata/views/catalog/* 
    into project's structure.
    '''
    sys.stdout.write('Setting Views...\n')
    os.chdir(HOME_DIR)
    src_path = os.path.join(os.path.curdir,'metadata', \
                            'views', \
                            'catalog', )
    dst_path = os.path.join(os.path.curdir, \
                            'base', 
                            'catalog', )
    for i in os.listdir(src_path):
        fsrc = os.path.join(src_path, i)
        shutil.copy(fsrc, dst_path)
    sys.stdout.write('Done\n')

def set_templates():
    '''
    Applying settings from 
    metadata/templates/catalog/*
    into project's structure.
    '''
    sys.stdout.write('Setting templates...\n')
    os.chdir(HOME_DIR)
    files = [
        'add.html',
        'converter.html',
        'delete.html',
        'detail.html',
        'fastupdate.html',
        'home.html',
        'index.html',
        'panorama.html',
        'search.html',
        'update.html',
        'upload.html'
        ]
    tmpl_srcdir = os.path.join(os.path.curdir, \
                               'metadata', \
                               'templates', \
                               'catalog',)
    tmpl_dstdir = os.path.join(os.path.curdir, \
                               'base', \
                               'catalog', \
                               'templates', \
                               'catalog',)
    tmpl_main_path = os.path.join(tmpl_srcdir, 'tmpl_main.html')
    # ensuring tmpl_dstdir exists:
    if not Path(tmpl_dstdir).is_dir():
        os.makedirs(tmpl_dstdir)
    # reading tmpl_main.html data content:
    fd = open(tmpl_main_path, 'rb') # 'rb' to avoid encoding problems.
    tmpl_main_data = fd.read()
    fd.close()
    for i in files:
        tmp = ''
        tmp = i.split('.')
        context = tmp[0]
        # the template files with custom content are <context_custom_content.html>:
        content_file = context + '_custom_content.html'
        content_file = os.path.join(tmpl_srcdir, content_file)
        fd = open(content_file, 'rb') # 'rb' to avoid encoding problems.
        custom_data = fd.read()
        fd.close()
        # all these templates are wrapped to tmpl_main.html (tmpl_main_data)
        tmpl_final_file = os.path.join(tmpl_dstdir, i)
        fd = open(tmpl_final_file, 'wb') # 'wb' to avoid encoding problems.
        data = tmpl_main_data.replace(b'__INSERT_CUSTOM_CONTENT__', \
                                      bytes(custom_data))
        fd.write(data)
        fd.close()

        '''
        Put risk/cvss calculators into Add form templates.
        It will look for the __RISK_CALCULATOR__ and 
        __CVSS_CALCULATOR__ tags.
        '''
        calculators = {
            'cvss': 'cvss_custom_content.html',
            'risk': 'risk_custom_content.html'
            }
        modals = {
            '1': 'tmpl_calculators_modal.html'
        }
        templates_with_calculator = [
            'add.html',
            'update.html',
            'fastupdate.html']
    for i in templates_with_calculator:
        #### Insert [risk,cvss]_custom_content.html
        risk_calc_path = os.path.join(tmpl_srcdir, calculators['risk'])
        cvss_calc_path = os.path.join(tmpl_srcdir, calculators['cvss'])
        modal_path = os.path.join(tmpl_srcdir, modals['1'])
        target_template = os.path.join(tmpl_dstdir, i)

        fd = open(risk_calc_path, 'rb')
        risk_calc_data = fd.read()
        fd.close()
        fd = open(cvss_calc_path, 'rb')
        cvss_calc_data = fd.read()
        fd.close()
        fd = open(modal_path, 'rb')
        modal_data = fd.read()
        fd.close()
        fd = open(target_template, 'rb')
        target_data = fd.read()
        fd.close()

        if (b'__CALCULATORS_MODAL__' in target_data):
            target_data = target_data.replace(b'__CALCULATORS_MODAL__',bytes(modal_data))
        if (b'__RISK_CALCULATOR__' in target_data):
            target_data = target_data.replace(b'__RISK_CALCULATOR__',bytes(risk_calc_data))
        if (b'__CVSS_CALCULATOR__' in target_data):
            target_data = target_data.replace(b'__CVSS_CALCULATOR__',bytes(cvss_calc_data))
                
        fd = open(target_template, 'wb') # 'wb' to avoid encoding problems.
        fd.write(target_data)
        fd.close()            
    sys.stdout.write('Done\n')

def set_login_template():
    sys.stdout.write('Setting login template...\n')
    os.chdir(HOME_DIR)
    tmpl_srcdir = os.path.join(os.path.curdir, \
                               'metadata', \
                               'templates', \
                               'catalog', \
                               'login.html')
    tmpl_dstdir = os.path.join(os.path.curdir, \
                               'base', \
                               'catalog', \
                               'templates', \
                               'catalog',)
    if not Path(tmpl_dstdir).is_dir():
        os.makedirs(tmpl_dstdir)
    shutil.copy(tmpl_srcdir, tmpl_dstdir)
    sys.stdout.write('Done\n')

def set_admin_template():
    # we just need to put static files in the right place.
    sys.stdout.write('Setting admin template confs:\n')
    os.chdir(HOME_DIR) 
    os.chdir(BASE_DIR)
    os.system(PYTHON_EXE + ' ' + 'manage.py collectstatic --noinput')
    os.chdir(HOME_DIR)  
    sys.stdout.write('Done\n')

def set_forms():
    sys.stdout.write('Setting Forms...\n')
    os.chdir(HOME_DIR)
    src_path = os.path.join(os.path.curdir,'metadata', \
                            'forms', \
                            'catalog', )
    dst_path = os.path.join(os.path.curdir, \
                            'base', \
                            'catalog', )
    for i in os.listdir(src_path):
        fsrc = os.path.join(src_path,i)
        shutil.copy(fsrc, dst_path)
    os.chdir(HOME_DIR)
    sys.stdout.write('Done\n')

def set_static_files():
    sys.stdout.write('Setting Static Files...\n')
    os.chdir(HOME_DIR)
    src_path = os.path.join(os.path.curdir, \
                            'metadata', \
                            'static', \
                            'catalog', )
    dst_path = os.path.join(os.path.curdir, \
                            'base', \
                            'catalog', \
                            'static', )
    if Path(dst_path).is_dir():
        shutil.rmtree(dst_path)
    shutil.copytree(src_path, dst_path)
    os.chdir(HOME_DIR) 
    sys.stdout.write('Done\n')

def deployment_checklist():
    sys.stdout.write('Deployment checklist...\n')
    # https://docs.djangoproject.com/en/2.0/howto/deployment/checklist/
    key = secrets.token_hex(64)
    src_path = os.path.join(HOME_DIR, \
                            'metadata', \
                            'settings', \
                            'settings.py')
    dst_path = os.path.join(HOME_DIR, 'base', \
                            'base', \
                            'settings.py')
    # Open template file and copy its content to avoid data appending:
    fd = open(src_path, 'r')
    data = fd.read()
    fd.close()
    # https://goo.gl/PtCXNN
    fd = open(dst_path, 'w')
    data = data.replace('__SECRET_KEY__', key)
    fd.write(data)
    fd.close()
    sys.stdout.write('Done\n')

def load_test_data():
    sys.stdout.write('Loading data from test/data-md.json\n')
    env = get_os()
    CURR_DIR = os.path.curdir
    os.chdir(HOME_DIR)
    src_path = os.path.join(os.path.curdir, \
                            'test', \
                            'data', \
                            'data-md.json')
    fixturename_path = os.path.join(HOME_DIR, \
                                    'base', \
                                    'catalog', \
                                    'fixturename',)   
    if not Path(fixturename_path).is_dir():
        os.mkdir(fixturename_path)
    shutil.copy(src_path, fixturename_path)
    os.chdir(PROJECT_NAME)
    fixturename_file = os.path.join(os.path.pardir, \
                                    fixturename_path, \
                                    'data-md.json')
    os.system(PYTHON_EXE + ' ' + 'manage.py loaddata' + ' ' + fixturename_file)
    os.chdir(CURR_DIR)  
    sys.stdout.write('Done\n')

def load_default_risk_questions():
    sys.stdout.write('Loading default Risk Questions...\n')
    CURR_DIR = os.path.curdir
    env = get_os()
    os.chdir(HOME_DIR)
    src_path = os.path.join(os.path.curdir, \
                            'test', \
                            'data', \
                            'riskQuestions-example.json')
    fixturename_path = os.path.join(HOME_DIR, \
                                    'base', \
                                    'catalog', \
                                    'fixturename',)    
    if not Path(fixturename_path).is_dir():
        os.mkdir(fixturename_path)
    shutil.copy(src_path, fixturename_path)
    os.chdir(PROJECT_NAME)
    fixturename_file = os.path.join(os.path.pardir, \
                                    fixturename_path, \
                                    'riskQuestions-example.json')
    os.system(PYTHON_EXE + ' ' + 'manage.py loaddata' + ' ' + fixturename_file)
    os.chdir(CURR_DIR)  
    sys.stdout.write('Done\n')

def create_superuser():
    env = get_os()
    os.chdir(BASE_DIR)
    os.system(PYTHON_EXE + ' ' + 'manage.py createsuperuser')
    os.chdir(HOME_DIR)

def set_database():
    # https://docs.djangoproject.com/en/2.0/ref/settings/#databases
    env = get_os()
    default_database = {
        'default': {
            'ENGINE': '',
            'NAME': '',
            'USER': '',
            'PASSWORD':'',
            'HOST': '',
            'PORT':''
        }
    }
    available_databases = {
    #   'key': ['DB friendly name', 'ENGINE', 'NAME', 'USER', 'PASS', HOST', 'PORT', 'db binding']
        '1': ['PostgreSQL', 'django.db.backends.postgresql', '', '', '', '127.0.0.1', '5432', 'psycopg2'],
        '2': ['MySQL', 'django.db.backends.mysql', '', '', '', '127.0.0.1', '3306', 'mysql-connector-python'],
        '3': ['Oracle', 'django.db.backends.oracle', '', '', '', '127.0.0.1', '1521', 'cx_Oracle'],
        '4': ['SQLite3', 'django.db.backends.sqlite3', "os.path.join(BASE_DIR, 'db.sqlite3')", '', '', '', '', None]
    }
    sys.stdout.write('\nAvailable databases:\n')
    for i in available_databases.keys():
        sys.stdout.write(i + ' - ' + available_databases[i][0] + '\n')    
    chosen_db = input('\nWhich one would you like to use? ')
    while chosen_db not in available_databases.keys():
        chosen_db = input('Choose one of the numbers above: ')
    sys.stdout.write('\nLet us set' + available_databases[chosen_db][0] + 'database:')
    default_database['default']['ENGINE'] = available_databases[chosen_db][1]
    default_database['default']['NAME'] = input('Database name: ' \
                                                + available_databases[chosen_db][2]) \
                                                or available_databases[chosen_db][2]
    default_database['default']['USER'] = input('Database user name: ' \
                                                + available_databases[chosen_db][3]) \
                                                or available_databases[chosen_db][3]
    default_database['default']['PASSWORD'] = getpass.getpass('User password:')
    pwd_verify = getpass.getpass('User password (again):')
    while default_database['default']['PASSWORD'] != pwd_verify:
        sys.stdout.write('Password mismatch.')
        default_database['default']['PASSWORD'] = getpass.getpass('User password:')
        pwd_verify = getpass.getpass('User password (again):')
    default_database['default']['HOST'] = input('Database Host address (' \
                                                + available_databases[chosen_db][5] \
                                                + '):') \
                                                or available_databases[chosen_db][5]
    default_database['default']['PORT'] = input('Database Port (' \
                                                + available_databases[chosen_db][6] \
                                                + '):') \
                                                or available_databases[chosen_db][6]
    #### Altering settings.py DATABASE entry:
    settings_path = os.path.join(os.curdir, 'base', 'base', 'settings.py')
    f = open(settings_path, 'r')
    data = f.read()
    f.close()
    regex = r"DATABASES = (.*)}\n" # Thanks to https://regex101.com/r/lH0jK9/1
    subst = json.dumps(default_database, indent=4)
    subst = subst.replace('"', '\'')
    subst = 'DATABASES = ' + subst + '\n'
    result = re.sub(regex, subst, data, 0, re.DOTALL)
    ### Since 'NAME': value is a path, it could not be treated as a string.
    if available_databases[chosen_db][0] == 'SQLite3':
        result = result.replace("'NAME': 'os.path.join(BASE_DIR, 'db.sqlite3')',", \
                                "'NAME': os.path.join(BASE_DIR, 'db.sqlite3'),")
    f = open(settings_path, 'w')
    f.write(result)
    f.close()
    #### Check if Database bindings is installed:
    db_binding = available_databases[chosen_db][7]
    try:
        import db_binding
    except ImportError:          
        os.system(PIP_EXE + ' ' + 'install ' + db_binding)
    set_datamodel()
      
def create_startscripts():
    env = get_os()

    system = env['system']
    if system.startswith('linux') or system.startswith('darwin'):
        filename = 'run.sh'
        f = open(filename, 'w')
        data = '#!/bin/bash\n\n' \
             + 'ADDRESS=""\n' \
             + 'if [[ $1 ]]; then\n' \
             + '  ADDRESS=$1\n' \
             + 'fi\n' \
             + 'if [[ -d ./venv ]]; then\n' \
             + '  source venv/bin/activate\n\n' \
             + 'fi\n' \
             + 'cd base\n' \
             + PYTHON_EXE + ' run_cherrypy.py $ADDRESS\n' \
             + 'cd ..\n'
        f.write(data)
        f.close()
        os.chmod(filename, 0o755)

    if system.startswith('win32'):
        filename = 'run.bat'
        f = open(filename, 'w')
        data = '@echo off\n\n' \
             + 'set ADDRESS=""\n' \
             + 'if not [%~1] == [] (set ADDRESS=%1)\n' \
             + 'if exist venv (\n' \
             + '  call venv\\Scripts\\activate.bat\n' \
             + ')\n' \
             + 'cd base\n' \
             + PYTHON_EXE + ' run_cherrypy.py %ADDRESS%\n' \
             + 'cd ..\n'
        f.write(data)
        f.close()

def update_js():
    '''
    Needs to take care about the licences as well. See ./LICENSES for more info.
    '''
    pass


def run():
    check_pip()
    check_venv()
    param = check_parameters()

    if param == 'build':
        check_parameters()
        get_os()
        check_system_reqs()
        deep_clean('none')
        start_django_project()
        importing_settings()
        set_datamodel()
        set_urls()
        set_views()
        set_templates()
        set_login_template()
        set_forms()
        set_static_files()
        set_admin_template()
        load_default_risk_questions()
        deployment_checklist()
        create_superuser()
        create_startscripts()
        importing_cherrypy_script()

    if param == 'build-only':
        check_parameters()
        get_os()
        check_system_reqs()
        deep_clean('none')
        start_django_project()
        importing_settings()
        set_datamodel()
        set_urls()
        set_views()
        set_templates()
        set_login_template()
        set_forms()
        set_static_files()
        set_admin_template()
        load_default_risk_questions()
        deployment_checklist()
        create_startscripts()
        importing_cherrypy_script()

    if param == 'build-novenv':
        check_parameters()
        get_os()
        check_system_reqs()
        deep_clean('none')
        start_django_project()
        importing_settings()
        set_datamodel()
        set_urls()
        set_views()
        set_templates()
        set_login_template()
        set_forms()
        set_static_files()
        set_admin_template()
        load_default_risk_questions()
        deployment_checklist()
        create_superuser()
        create_startscripts()
        importing_cherrypy_script()
        
    if param == 'clean':
        deep_clean('none')
    
    if param == 'createsuperuser':
        create_superuser()

    if param == 'database':
        set_database()

    if param == 'deep-clean':
        deep_clean('deep-clean')

    if param == 'templates':
        set_templates()
        set_login_template()
        set_forms()
        set_static_files()
        set_admin_template()

    if param == 'urlsviews':
        set_urls()
        set_views()
        
    if param == 'loadtestdata':
        load_test_data()

    if param == 'createstartscript':
        create_startscripts()

    if param == 'update-js':
        update_js()


run()
