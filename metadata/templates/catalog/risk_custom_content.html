<!--risk_custom_content.html-->
<br>
<br>
{% if not riskquestions_list %}
  <div class="container">
    <div class="alert alert-secondary">
     <strong>No risk questions found at database. <a href="/admin/catalog/riskquestions/" class="btn btn-success btn-sm active" role="button" aria-pressed="true">Add some?</a>
    </div>
  </div>
{% else %}
  <form id="riskForm" oninput="riskCalculator()">
    <div class="container">

      <div class="card">
        <div class="card-header">
          <div class="row">
            <div class="col">
              <strong>Risk level:</strong>
              <Big><strong><span id="riskMetric">0</span></strong></Big>
            </div>
            <div class="col text-right">
              <h3><span class="badge badge-secondary" id="riskLevel">Low</span></h3>
            </div>
          </div>
        </div>

        <div class="card-body">
        {% for question in riskquestions_list %}
          {% if question.position == 0 %}
            <div class="card-block">
              <p>{{ question.question }}</p>
            </div>
            <hr>
          {% endif %}
        {% endfor %}
        {% for question in riskquestions_list %}
          {% if question.position > 0 %}
            <div class="card-block">
              <div class="row">
                <div class="col">
                  <span><strong>{{ question.position}}. {{ question.question }}</strong></span>
                </div>
                <div class="col">
                  <input class="risk-question" id="{{ question.question_shortname }}" type="range" min="0" max="10" value="0" title="Evaluate it in terms of loss of confidentiality, integrity or authenticity.">
                  <span class="badge badge-light risk-value" id="{{ question.question_shortname }}Value"></span>
                </div>
              </div>
            </div>
            <hr>
          {% endif %}
        {% endfor %}

          <div class="card-footer text-muted">
            <div class="row">
              <div class="col">
                <span><strong id="riskVectorLabel"></strong></span>
                <span class="badge badge-success" id="riskVectorValue"></span>
              </div>
              <div class="col text-right">
                <a class="btn btn-secondary btn-sm active" role="button" aria-pressed="true" href="/admin/catalog/riskquestions/">Change questions?</a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </form>

<br class="clear">
<br class="clear">
{% endif %}

<script>

  function riskCalculator() {
  
    var riskMetric; // The metric of all risk values presented by the user.
    var riskVector = {}; // Get all the provided risk metrics.
    var numberOfQuestions; // Number of questions in the form.
    var maxRiskLevel = {}; // This should be one of ["High", "Medium", "Low"]
    
    // Creating the initial riskVector:
    let riskQuestionsCollection = document.getElementsByClassName("risk-question");
    let riskValueCollection = document.getElementsByClassName("risk-value");
    
    numberOfQuestions = riskQuestionsCollection.length;
    for (let i=0; i<numberOfQuestions; i++) {
      riskVector[riskQuestionsCollection[i].id] = riskQuestionsCollection[i].valueAsNumber;
    }
    
    // Adding all values:
    riskMetric = Object.values(riskVector).reduce((a, b) => a + b, 0);

    // Calculating the risk level beyond it risk level changes:
    let maxValue = 10 * numberOfQuestions;
    maxRiskLevel["Low"] = maxValue / 3;
    maxRiskLevel["Medium"] = 2*(maxValue / 3);
    maxRiskLevel["High"] = maxValue;
    
    // If an unique measure is greater than 7, risk level is High:
    if ( 
      Object.values(riskVector).some(
        function(element, index, array) { return element > 7; })
      ) 
    {
      riskLevel = "High";
    } else if ( // If an unique measure is great than 4, risk level is Medium:
      Object.values(riskVector).some(
        function(element, index, array) { return element > 4; })
      ) 
    {
      riskLevel = "Medium";    
    } else { // risk level depends on the evaluation of all fields:
      if (0 <= riskMetric && riskMetric <= maxRiskLevel["Low"]) {
        riskLevel = "Low";
      }
      if (maxRiskLevel["Low"] < riskMetric && riskMetric <= maxRiskLevel["Medium"]) {
        riskLevel = "Medium";
      }
      if (maxRiskLevel["Medium"] < riskMetric && riskMetric <= maxRiskLevel["High"]) {
        riskLevel = "High";
      }
        
    }

    // Presenting the Risk level as percentage:  
    document.getElementById("riskMetric")
              .innerHTML = (riskMetric * 2) + "% <small><small><span class='text-muted'>of all listed concerns.</span></small></small>";
    document.getElementById("riskLevel").innerHTML = riskLevel;
      
    // setting Risk colors by level:
    if (riskLevel == "High") {
      document.getElementById("riskLevel")
              .setAttribute("class", "badge badge-danger");
    } 
    else if (riskLevel == "Medium") {
      document.getElementById("riskLevel")
              .setAttribute("class", "badge badge-warning");
    } 
    else if (riskLevel == "Low") {
      document.getElementById("riskLevel")
              .setAttribute("class", "badge badge-secondary");
    } else {
      document.getElementById("riskLevel")
              .setAttribute("class", "badge badge-secondary");
    }

    // Presenting the risk vector: 
    let rv = "RV: " + JSON.stringify(riskVector);
    document.getElementById("riskVectorLabel")
            .innerHTML = ("Risk vector string - ")
    document.getElementById("riskVectorValue")
            .innerHTML = (rv);

//    console.log(riskVector);
//    console.log(riskMetric);
//    console.log(riskLevel);
  }

</script>
<!--risk_custom_content.html-->