import json
from datetime import datetime

from django.views.generic import ListView
from django.core import serializers
from django.http import HttpRequest, HttpResponse
from django.http import HttpResponseForbidden, HttpResponseNotFound
from django.urls import reverse
from django.apps import apps
from django.contrib.auth.decorators import login_required, permission_required
from django.utils.decorators import method_decorator

from .models import Vulnerability, RiskQuestions

login_url='catalog:login'
decorators = [login_required(login_url=login_url)]

today = datetime.today().strftime('%Y-%b-%d-%H%M')
output_file = 'VC-export-' + today + '.json'

@method_decorator(decorators, name='dispatch')
@method_decorator(permission_required('catalog.read_vulnerability', \
    raise_exception=True), name='dispatch')
class JsonExportView(ListView):
    '''
    Exports vulnerabilities and risk questions to a JSON file.
    Call it at:
    /catalog/vulnerability/data/json/export
    '''
    def export_database(HttpRequest):
    
        all_objects = list(Vulnerability.objects.all()) \
                    + list(RiskQuestions.objects.all()) 
                            
        result = serializers.serialize('json', all_objects)
        response = HttpResponse(result, content_type='application/json')
        response['Content-Disposition'] = 'attachment; filename=' + output_file

        return response
