from django.views.generic.edit import CreateView

from django.http import HttpRequest, HttpResponse
from django.http import HttpResponseForbidden, HttpResponseRedirect
from django.urls import reverse

from django.contrib.auth.decorators import login_required, permission_required
from django.utils.decorators import method_decorator

from .models import Vulnerability

login_url='catalog:login'
success_url='catalog:index'
decorators = [login_required(login_url='catalog:login')]

#########################################################################
#### Warning: requires catalog.add_vulnerability user permission.
#########################################################################
@method_decorator(decorators, name='dispatch')
@method_decorator(permission_required('catalog.add_vulnerability', \
    raise_exception=True), name='dispatch')
class FileUpload(CreateView):
    model = Vulnerability
    template_name = 'catalog/upload.html'

    def getfile(HttpRequest):
        #### Unfortunately, decorators do not work here:
        if not HttpRequest.user.is_authenticated:
            return HttpResponseRedirect(reverse(login_url))
        if not HttpRequest.user.has_perm('catalog.add_vulnerability'):
            return HttpResponseForbidden("<h1>403 Forbidden</h1>")

        # https://docs.djangoproject.com/en/2.0/ref/request-response/#django.http.HttpRequest.FILES
        files = HttpRequest.FILES
        print(HttpRequest)
        print(files)

        return HttpResponseRedirect(reverse(success_url))


        